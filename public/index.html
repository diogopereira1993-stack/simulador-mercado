<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Minha Carteira</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Estilos dos Cart√µes */
        .portfolio-card {
            background: #161b22;
            border-radius: 15px;
            padding: 15px;
            margin: 10px 20px;
            border: 1px solid #333;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .portfolio-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .portfolio-label { font-size: 0.8rem; color: #888; text-transform: uppercase; }
        .portfolio-value { font-size: 1.1rem; font-weight: bold; color: white; }
        
        .gain-loss { font-size: 1.5rem; font-weight: 800; }
        .positive { color: #00ff88; }
        .negative { color: #ff4444; }
        
        /* Cores P/E */
        .pe-high { color: #ff4444; } 
        .pe-low { color: #00ff88; }
        
        /* Anima√ß√µes de Pre√ßo */
        .flash-up { animation: flashGreen 0.5s; }
        .flash-down { animation: flashRed 0.5s; }
        @keyframes flashGreen { 0% { background-color: rgba(0,255,136,0.2); } 100% { background-color: transparent; } }
        @keyframes flashRed { 0% { background-color: rgba(255,68,68,0.2); } 100% { background-color: transparent; } }

        /* O POPUP VISUAL (Restaurado) */
        .vote-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 255, 136, 0.95); /* Verde Matrix */
            color: #000;
            padding: 15px 30px;
            border-radius: 30px;
            font-weight: 900;
            font-size: 1.2rem;
            z-index: 9999;
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.5);
            white-space: nowrap;
            pointer-events: none;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            80% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
    </style>
</head>
<body class="mobile-body">
    <div id="status-bar" class="status-paused">AGUARDANDO...</div>
    
    <div class="header">
        <h1>LUSI <span style="font-size: 0.8rem; color:#666;">(Lusitana Tech)</span></h1>
        <div id="price-display" class="big-price">--- ‚Ç¨</div>
    </div>

    <div class="portfolio-card" style="border-left: 4px solid #007bff;">
        <div class="portfolio-row">
            <span class="portfolio-label">Market Cap</span>
            <span id="market-cap" class="portfolio-value">---</span>
        </div>
        <div class="portfolio-row">
            <span class="portfolio-label">P/E Ratio</span>
            <span id="pe-ratio" class="portfolio-value">---</span>
        </div>
        <div class="portfolio-row">
            <span class="portfolio-label" style="color:#007bff">EPS (Lucro/A√ß√£o)</span>
            <span id="eps-val" class="portfolio-value" style="color:#007bff">---</span>
        </div>
    </div>

    <div class="portfolio-card" id="portfolio-box" style="opacity: 0.5;">
        <div class="portfolio-row">
            <div>
               <div class="portfolio-label">Pre√ßo M√©dio (Qtd)</div>
                <div class="portfolio-value" id="my-entry">---</div>
            </div>
            <div style="text-align: right;">
                <div class="portfolio-label">Teu Resultado</div>
                <div class="portfolio-value gain-loss" id="my-pnl">0.00%</div>
            </div>
        </div>
        <div style="font-size: 0.7rem; color: #555; text-align: center; margin-top: 5px;">
            <span id="position-status">Faz o teu primeiro voto para entrar</span>
        </div>
    </div>

    <div class="news-ticker">
        <marquee id="news-text">Bem-vindo ao Mercado</marquee>
    </div>

    <div class="controls">
        <button id="btn-buy" class="btn buy" onclick="vote('BUY')">COMPRAR üîº</button>
        <button id="btn-hold" class="btn hold" onclick="vote('HOLD')">MANTER ‚è∏</button>
        <button id="btn-sell" class="btn sell" onclick="vote('SELL')">VENDER üîΩ</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const priceDisplay = document.getElementById('price-display');
        const statusBar = document.getElementById('status-bar');
        const newsText = document.getElementById('news-text');
        
        // --- NOVAS VARI√ÅVEIS DE CARTEIRA ---
        let isCoolingDown = false; 
        let currentMarketPrice = 0;
        
        // Carteira do Utilizador
        let myShares = 0;      // Quantas a√ß√µes tenho
        let myAvgPrice = 0;    // O meu pre√ßo m√©dio de compra
        let hasInteracted = false;

        // Ouve apenas o canal leve (Otimiza√ß√£o 500px)
        socket.on('market-update-light', (data) => {
            currentMarketPrice = parseFloat(data.price);
            
            // 1. Atualiza Pre√ßo Grande e Flash
            const oldPrice = parseFloat(priceDisplay.innerText.replace('‚Ç¨',''));
            priceDisplay.innerText = data.price + "‚Ç¨";
            
            if (currentMarketPrice > oldPrice) priceDisplay.classList.add('flash-up');
            else if (currentMarketPrice < oldPrice) priceDisplay.classList.add('flash-down');
            setTimeout(() => priceDisplay.classList.remove('flash-up', 'flash-down'), 500);

            // 2. Atualiza Dados Fundamentais (Cards de cima)
            document.getElementById('market-cap').innerText = data.marketCap + " ‚Ç¨";
            document.getElementById('eps-val').innerText = data.eps + "‚Ç¨";
            
            const peEl = document.getElementById('pe-ratio');
            peEl.innerText = data.peRatio;
            let pe = parseFloat(data.peRatio);
            peEl.className = "portfolio-value " + (pe > 40 ? "pe-high" : (pe < 15 ? "pe-low" : ""));

            // 3. Not√≠cias e Estado
            newsText.innerText = data.news;
            
            if (data.isPaused) {
                statusBar.innerText = "MERCADO PAUSADO";
                statusBar.className = "status-paused";
                document.body.style.opacity = "0.7";
            } else {
                statusBar.innerText = "MERCADO ABERTO üü¢";
                statusBar.className = "status-live";
                document.body.style.opacity = "1";
            }

            // 4. ATUALIZA A CARTEIRA PESSOAL EM TEMPO REAL
            if (hasInteracted) updateMyPortfolio();
        });

        function vote(action) {
            if (isCoolingDown) return;
            
            // L√≥gica de Carteira (Client-Side)
            if (action === 'BUY') {
                // C√°lculo de Pre√ßo M√©dio Ponderado
                // (Pre√ßo Antigo * Qtd Antiga + Pre√ßo Novo) / Nova Qtd
                let totalValue = (myShares * myAvgPrice) + currentMarketPrice;
                myShares++; 
                myAvgPrice = totalValue / myShares;
                
                showPopup("COMPRA (+1) üìà");
            } 
            else if (action === 'SELL') {
                if (myShares > 0) {
                    myShares--; // Vende uma a√ß√£o
                    // Nota: Vender n√£o muda o pre√ßo m√©dio das a√ß√µes que sobram
                    showPopup("VENDA (-1) üìâ");
                } else {
                    // Se n√£o tem a√ß√µes, vota na mesma (press√£o de venda), mas n√£o muda carteira
                    showPopup("ORDEM VENDA üìâ");
                }
            } 
            else {
                showPopup("MANTER ‚è∏");
            }

            // Regista que j√° entrou no jogo
            if (!hasInteracted) {
                hasInteracted = true;
                document.getElementById('portfolio-box').style.opacity = "1";
            }

            // Envia voto para o servidor (para mexer o mercado)
            socket.emit('vote', action);
            
            if (navigator.vibrate) navigator.vibrate(50);
            updateMyPortfolio();
            activateCooldown(3000); 
        }

        function updateMyPortfolio() {
            // Atualiza Interface da Carteira
            
            // Mostra Pre√ßo M√©dio e Quantidade
            // Ex: "Avg: 50.00‚Ç¨ (10 un)"
            document.getElementById('my-entry').innerText = 
                myShares > 0 
                ? `${myAvgPrice.toFixed(2)}‚Ç¨ (${myShares}x)` 
                : "---";

            document.getElementById('position-status').innerText = 
                myShares > 0 
                ? "Investidor Ativo" 
                : "Sem Posi√ß√µes Abertas";

            // C√°lculo do Lucro/Preju√≠zo (PnL)
            // (Pre√ßo Atual - Pre√ßo M√©dio) / Pre√ßo M√©dio
            if (myShares > 0 && myAvgPrice > 0) {
                let variation = ((currentMarketPrice - myAvgPrice) / myAvgPrice) * 100;
                const pnlElement = document.getElementById('my-pnl');
                
                let sign = variation >= 0 ? "+" : "";
                pnlElement.innerText = sign + variation.toFixed(2) + "%";
                
                // Cor: Verde se positivo, Vermelho se negativo
                pnlElement.className = "portfolio-value gain-loss " + (variation >= 0 ? "positive" : "negative");
            } else {
                document.getElementById('my-pnl').innerText = "0.00%";
                document.getElementById('my-pnl').className = "portfolio-value gain-loss";
            }
        }

        function showPopup(text) {
            const popup = document.createElement('div');
            popup.className = 'vote-popup';
            popup.innerText = text;
            document.body.appendChild(popup);
            setTimeout(() => {
                popup.style.opacity = '0';
                popup.style.transition = 'opacity 0.3s';
                setTimeout(() => popup.remove(), 300);
            }, 1200);
        }

        function activateCooldown(time) {
            isCoolingDown = true;
            const btns = document.querySelectorAll('.btn');
            btns.forEach(btn => btn.disabled = true);
            setTimeout(() => {
                isCoolingDown = false;
                btns.forEach(btn => btn.disabled = false);
            }, time);
        }
    </script>
</body>
</html>
