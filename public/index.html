<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Minha Carteira</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .portfolio-card { background: #161b22; border-radius: 15px; padding: 15px; margin: 10px 20px; border: 1px solid #333; }
        .portfolio-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .portfolio-label { font-size: 0.8rem; color: #888; text-transform: uppercase; }
        .portfolio-value { font-size: 1.1rem; font-weight: bold; color: white; }
        .gain-loss { font-size: 1.5rem; font-weight: 800; }
        .positive { color: #00ff88; } .negative { color: #ff4444; }
        .pe-high { color: #ff4444; } .pe-low { color: #00ff88; }
        .flash-up { animation: flashGreen 0.5s; } .flash-down { animation: flashRed 0.5s; }
        @keyframes flashGreen { 0% { background-color: rgba(0,255,136,0.2); } 100% { background-color: transparent; } }
        @keyframes flashRed { 0% { background-color: rgba(255,68,68,0.2); } 100% { background-color: transparent; } }
    </style>
</head>
<body class="mobile-body">
    <div id="status-bar" class="status-paused">AGUARDANDO...</div>
    <div class="header"><h1>LUSI <span style="font-size: 0.8rem; color:#666;">(Lusitana Tech)</span></h1><div id="price-display" class="big-price">--- ‚Ç¨</div></div>

    <div class="portfolio-card" style="border-left: 4px solid #007bff;">
        <div class="portfolio-row"><span class="portfolio-label">Market Cap</span><span id="market-cap" class="portfolio-value">---</span></div>
        <div class="portfolio-row"><span class="portfolio-label">P/E Ratio</span><span id="pe-ratio" class="portfolio-value">---</span></div>
        <div class="portfolio-row"><span class="portfolio-label" style="color:#007bff">EPS (TTM)</span><span id="eps-val" class="portfolio-value" style="color:#007bff">---</span></div>
    </div>

    <div class="portfolio-card" id="portfolio-box" style="opacity: 0.5;">
        <div class="portfolio-row">
            <div><div class="portfolio-label">Entrada</div><div class="portfolio-value" id="my-entry">---</div></div>
            <div style="text-align: right;"><div class="portfolio-label">Resultado</div><div class="portfolio-value gain-loss" id="my-pnl">0.00%</div></div>
        </div>
        <div style="font-size: 0.7rem; color: #555; text-align: center; margin-top: 5px;"><span id="position-status">Faz o primeiro voto para entrar</span></div>
    </div>

    <div class="news-ticker"><marquee id="news-text">Bem-vindo ao Mercado</marquee></div>

    <div class="controls">
        <button class="btn buy" onclick="vote('BUY')">COMPRAR üîº</button>
        <button class="btn hold" onclick="vote('HOLD')">MANTER ‚è∏</button>
        <button class="btn sell" onclick="vote('SELL')">VENDER üîΩ</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const priceDisplay = document.getElementById('price-display');
        const statusBar = document.getElementById('status-bar');
        
        let isCoolingDown = false; let myEntryPrice = 0; let hasEntered = false; let currentMarketPrice = 0;

        socket.on('market-update-light', (data) => {
            currentMarketPrice = parseFloat(data.price);
            priceDisplay.innerText = data.price + "‚Ç¨";
            
            // Dados
            document.getElementById('market-cap').innerText = data.marketCap;
            document.getElementById('eps-val').innerText = data.eps + "‚Ç¨";
            
            const peEl = document.getElementById('pe-ratio');
            peEl.innerText = data.peRatio;
            let pe = parseFloat(data.peRatio);
            peEl.className = "portfolio-value " + (pe > 40 ? "pe-high" : (pe < 15 ? "pe-low" : ""));

            document.getElementById('news-text').innerText = data.news;
            if (hasEntered) updateMyPortfolio();

            statusBar.innerText = data.isPaused ? "MERCADO PAUSADO" : "MERCADO ABERTO üü¢";
            statusBar.className = data.isPaused ? "status-paused" : "status-live";
            document.body.style.opacity = data.isPaused ? "0.7" : "1";
        });

        function vote(action) {
            if (isCoolingDown) return;
            if (!hasEntered && currentMarketPrice > 0) {
                hasEntered = true; myEntryPrice = currentMarketPrice;
                document.getElementById('my-entry').innerText = myEntryPrice.toFixed(2) + "‚Ç¨";
                document.getElementById('portfolio-box').style.opacity = "1";
                document.getElementById('position-status').innerText = "Posi√ß√£o Aberta";
            }
            socket.emit('vote', action);
            if (navigator.vibrate) navigator.vibrate(50);
            activateCooldown(3000); 
        }

        function updateMyPortfolio() {
            let variation = ((currentMarketPrice - myEntryPrice) / myEntryPrice) * 100;
            const pnl = document.getElementById('my-pnl');
            pnl.innerText = (variation >= 0 ? "+" : "") + variation.toFixed(2) + "%";
            pnl.className = "portfolio-value gain-loss " + (variation >= 0 ? "positive" : "negative");
        }

        function activateCooldown(time) {
            isCoolingDown = true;
            document.querySelectorAll('.btn').forEach(b => b.disabled = true);
            setTimeout(() => { isCoolingDown = false; document.querySelectorAll('.btn').forEach(b => b.disabled = false); }, time);
        }
    </script>
</body>
</html>
