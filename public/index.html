<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Minha Carteira - MoneyFlix</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Estilo Extra para o Portfolio Pessoal */
        .portfolio-card {
            background: #161b22;
            border-radius: 15px;
            padding: 20px;
            margin: 10px 20px;
            border: 1px solid #333;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .portfolio-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .portfolio-label { font-size: 0.8rem; color: #888; text-transform: uppercase; }
        .portfolio-value { font-size: 1.2rem; font-weight: bold; color: white; }
        
        .gain-loss { font-size: 1.5rem; font-weight: 800; }
        .positive { color: #00ff88; }
        .negative { color: #ff4444; }
        
        /* Pequena anima√ß√£o quando o valor muda */
        .flash-up { animation: flashGreen 0.5s; }
        .flash-down { animation: flashRed 0.5s; }
        
        @keyframes flashGreen { 0% { background-color: rgba(0,255,136,0.2); } 100% { background-color: transparent; } }
        @keyframes flashRed { 0% { background-color: rgba(255,68,68,0.2); } 100% { background-color: transparent; } }
    </style>
</head>
<body class="mobile-body">
    <div id="status-bar" class="status-paused">AGUARDANDO...</div>
    
    <div class="header">
        <h1>LUSI <span style="font-size: 0.8rem; color:#666;">(Lusitana Tech)</span></h1>
        <div id="price-display" class="big-price">--- ‚Ç¨</div>
    </div>

    <div class="portfolio-card" style="border-left: 4px solid #007bff; margin-bottom: 5px;">
        <div class="portfolio-row">
            <div>
                <div class="portfolio-label">Market Cap</div>
                <div class="portfolio-value" id="mkt-cap">---</div>
            </div>
            <div style="text-align: right;">
                <div class="portfolio-label">P/E Ratio</div>
                <div class="portfolio-value" id="pe-ratio">---</div>
            </div>
        </div>
        </div>

    <div class="portfolio-card" id="portfolio-box" style="opacity: 0.5;">
        <div class="portfolio-row">
            <div>
                <div class="portfolio-label">O Teu Pre√ßo Entrada</div>
                <div class="portfolio-value" id="my-entry">---</div>
            </div>
            <div style="text-align: right;">
                <div class="portfolio-label">Teu Resultado</div>
                <div class="portfolio-value gain-loss" id="my-pnl">0.00%</div>
            </div>
        </div>
        <div style="font-size: 0.7rem; color: #555; text-align: center; margin-top: 5px;">
            <span id="position-status">Faz o teu primeiro voto para entrar</span>
        </div>
    </div>

    <div class="news-ticker">
        <marquee id="news-text">Bem-vindo ao Mercado</marquee>
    </div>

    <div class="controls">
        <button id="btn-buy" class="btn buy" onclick="vote('BUY')">COMPRAR üîº</button>
        <button id="btn-hold" class="btn hold" onclick="vote('HOLD')">MANTER ‚è∏</button>
        <button id="btn-sell" class="btn sell" onclick="vote('SELL')">VENDER üîΩ</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const priceDisplay = document.getElementById('price-display');
        const statusBar = document.getElementById('status-bar');
        const newsText = document.getElementById('news-text');
        
        // Vari√°veis Locais do Utilizador
        let isCoolingDown = false; 
        let myEntryPrice = 0;
        let hasEntered = false;
        let currentMarketPrice = 0;

        // OTIMIZA√á√ÉO: Ouve apenas o canal leve 'market-update-light'
        socket.on('market-update-light', (data) => {
            currentMarketPrice = parseFloat(data.price);
            
            // Atualizar Pre√ßo Geral
            const oldPrice = parseFloat(priceDisplay.innerText.replace('‚Ç¨',''));
            priceDisplay.innerText = data.price + "‚Ç¨";
            
            // Efeito visual no pre√ßo
            if (currentMarketPrice > oldPrice) priceDisplay.classList.add('flash-up');
            else if (currentMarketPrice < oldPrice) priceDisplay.classList.add('flash-down');
            setTimeout(() => priceDisplay.classList.remove('flash-up', 'flash-down'), 500);

            // Novos Dados Fundamentais (SEM O VALOR JUSTO)
            document.getElementById('mkt-cap').innerText = data.marketCap + " ‚Ç¨";
            // A linha que atualizava o fair-val foi removida para n√£o dar erro
            
            const peEl = document.getElementById('pe-ratio');
            peEl.innerText = data.peRatio;
            
            // L√≥gica de Cores do P/E (A √∫nica pista que eles t√™m agora!)
            if (parseFloat(data.peRatio) > 40) peEl.style.color = "#ff4444"; // Caro/Perigoso
            else if (parseFloat(data.peRatio) < 15) peEl.style.color = "#00ff88"; // Barato/Oportunidade
            else peEl.style.color = "white"; // Normal

            newsText.innerText = data.news;
            
            // Atualizar O MEU Portfolio
            if (hasEntered) {
                updateMyPortfolio();
            }

            // Estado do Mercado
            if (data.isPaused) {
                statusBar.innerText = "MERCADO PAUSADO";
                statusBar.className = "status-paused";
                document.body.style.opacity = "0.7";
            } else {
                statusBar.innerText = "MERCADO ABERTO üü¢";
                statusBar.className = "status-live";
                document.body.style.opacity = "1";
            }
        });

        function vote(action) {
            if (isCoolingDown) return;

            // L√≥gica de Entrada
            if (!hasEntered && currentMarketPrice > 0) {
                hasEntered = true;
                myEntryPrice = currentMarketPrice;
                
                document.getElementById('my-entry').innerText = myEntryPrice.toFixed(2) + "‚Ç¨";
                document.getElementById('portfolio-box').style.opacity = "1";
                document.getElementById('position-status').innerText = "Posi√ß√£o Aberta";
            }

            // Enviar voto
            socket.emit('vote', action);
            
            if (navigator.vibrate) navigator.vibrate(50);
            showPopup("ORDEM ENVIADA! üìù");
            activateCooldown(3000); 
        }

        function updateMyPortfolio() {
            let variation = ((currentMarketPrice - myEntryPrice) / myEntryPrice) * 100;
            const pnlElement = document.getElementById('my-pnl');
            
            let sign = variation >= 0 ? "+" : "";
            pnlElement.innerText = sign + variation.toFixed(2) + "%";

            if (variation >= 0) {
                pnlElement.className = "portfolio-value gain-loss positive";
            } else {
                pnlElement.className = "portfolio-value gain-loss negative";
            }
        }

        function showPopup(text) {
            const popup = document.createElement('div');
            popup.className = 'vote-popup';
            popup.innerText = text;
            document.body.appendChild(popup);
            setTimeout(() => {
                popup.style.opacity = '0';
                setTimeout(() => popup.remove(), 300);
            }, 1500);
        }

        function activateCooldown(time) {
            isCoolingDown = true;
            const btns = document.querySelectorAll('.btn');
            btns.forEach(btn => btn.disabled = true);
            setTimeout(() => {
                isCoolingDown = false;
                btns.forEach(btn => btn.disabled = false);
            }, time);
        }
    </script>
</body>
</html>
