<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - MoneyFlix</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- ESTILO GERAL (MANTIDO IGUAL) --- */
        body { 
            background-color: #0a0e17; 
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
            margin: 0;
            padding: 20px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        .header-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 20px; height: 15%; }
        .brand-name { font-size: 2.5rem; font-weight: 800; letter-spacing: 2px; color: #888; }
        .big-price-display { font-size: 6rem; font-weight: 700; font-variant-numeric: tabular-nums; color: white; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .price-up { color: #00ff88; } 
        .price-down { color: #ff4444; }

        .chart-wrapper {
            flex-grow: 1; position: relative; width: 100%;
            background: rgba(255,255,255,0.02); border-radius: 8px; padding: 10px;
            box-sizing: border-box; border: 1px solid #222;
        }

        .status-badge { font-size: 1.2rem; font-weight: bold; padding: 5px 15px; border-radius: 4px; background: #222; color: #666; margin-top: 5px; display: inline-block; }
        
        .news-footer {
            height: 10%; margin-top: 20px; background: #111; padding: 0 15px;
            border-radius: 5px; display: flex; align-items: center; border-left: 4px solid #444;
        }
    </style>
</head>
<body>

    <div class="header-row">
        <div style="display: flex; flex-direction: column;">
            <div class="brand-name">LUSI</div>
            <div id="status-display" class="status-badge">AGUARDANDO...</div>
        </div>
        <div id="main-price" class="big-price-display">--- €</div>
    </div>

    <div class="chart-wrapper">
        <canvas id="marketChart"></canvas>
    </div>

    <div class="news-footer">
        <span style="background: #333; color: white; padding: 5px 10px; font-weight: bold; font-size: 0.8rem; margin-right: 15px;">NOTÍCIAS</span>
        <marquee id="news-marquee" style="font-size: 1.8rem; color: #ddd; font-weight: 300;">Bem-vindo ao Mercado.</marquee>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const priceEl = document.getElementById('main-price');
        const statusEl = document.getElementById('status-display');
        const newsEl = document.getElementById('news-marquee');
        const ctx = document.getElementById('marketChart').getContext('2d');
        
        let marketChart; // Variável para controlar o gráfico

        // FUNÇÃO: INICIAR GRÁFICO (MODO LIVE)
        // Esta função cria o gráfico normal que vês durante o jogo
        function initLiveChart() {
            if (marketChart) marketChart.destroy();

            marketChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Preço (€)',
                        data: [],
                        borderColor: '#ffffff',
                        borderWidth: 3,
                        backgroundColor: 'rgba(255, 255, 255, 0.05)',
                        fill: true,
                        pointRadius: 0,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, animation: false,
                    scales: {
                        x: { display: true, grid: { color: '#333' }, ticks: { color: '#666', maxTicksLimit: 12 } },
                        y: { position: 'right', grid: { color: '#333' }, ticks: { color: '#888' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // Arranca o gráfico vazio logo ao início
        initLiveChart();
        let lastPrice = 0;

        // --- MODO 1: LIVE (Igual ao antigo) ---
        socket.on('market-update', (data) => {
            if (data.mode === 'LIVE') {
                const currentPrice = parseFloat(data.price);
                priceEl.innerText = data.price + "€";
                
                // Cores do preço
                if (currentPrice > lastPrice) { 
                    priceEl.className = "big-price-display price-up"; 
                    if(marketChart) marketChart.data.datasets[0].borderColor = '#00ff88'; 
                } else if (currentPrice < lastPrice) { 
                    priceEl.className = "big-price-display price-down"; 
                    if(marketChart) marketChart.data.datasets[0].borderColor = '#ff4444'; 
                } else { 
                    priceEl.className = "big-price-display"; 
                }
                lastPrice = currentPrice;

                statusEl.innerText = data.isPaused ? "MERCADO FECHADO" : "● EM TEMPO REAL";
                statusEl.style.color = data.isPaused ? "#666" : "#ff4444";
                if (newsEl.innerText !== data.news) newsEl.innerText = data.news;

                // Atualiza os dados do gráfico existente
                if (marketChart) {
                    marketChart.data.labels = data.history.map(h => h.time);
                    marketChart.data.datasets[0].data = data.history.map(h => h.price);
                    marketChart.update();
                }
            }
        });

        // --- MODO 2: FINAL (AQUI ESTÁ A CORREÇÃO "NUCLEAR") ---
        socket.on('market-finish', (data) => {
            console.log("Recebendo dados finais...", data);
            
            // 1. Atualizar textos
            statusEl.innerText = "ANÁLISE FINAL";
            statusEl.style.color = "#9d00ff";
            statusEl.style.border = "1px solid #9d00ff";
            newsEl.innerText = "SESSÃO TERMINADA - HISTÓRICO COMPLETO";

            // 2. DESTRUIR O GRÁFICO ANTIGO (O segredo para funcionar!)
            if (marketChart) marketChart.destroy();

            // 3. Preparar as bolas
            const fullLabels = data.fullHistory.map(h => h.time);
            
            // Mapeia eventos para coordenadas X/Y
            const eventPoints = data.events.map(evt => {
                return {
                    x: evt.time, 
                    y: evt.price,
                    newsText: evt.text
                };
            });

            // Define cores das bolas
            const pointColors = data.events.map(evt => {
                if (evt.impact > 0) return '#00ff88'; // Verde
                if (evt.impact < 0) return '#ff4444'; // Vermelho
                return '#ffd700'; // Amarelo
            });

            // 4. CRIAR NOVO GRÁFICO ESTÁTICO (Com o mesmo estilo do antigo)
            marketChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: fullLabels, // Usa TODOS os dados
                    datasets: [
                        {
                            label: 'Preço (€)',
                            data: data.fullHistory.map(h => h.price),
                            borderColor: '#ffffff', // Branco neutro
                            borderWidth: 2,
                            backgroundColor: 'rgba(255, 255, 255, 0.05)',
                            fill: true,
                            pointRadius: 0,
                            tension: 0.3,
                            order: 2
                        },
                        {
                            label: 'Eventos',
                            type: 'scatter', // Bolas
                            data: eventPoints,
                            pointRadius: 15,       // Bolas Grandes
                            pointHoverRadius: 20,
                            backgroundColor: pointColors,
                            borderColor: 'white',
                            borderWidth: 2,
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 2000, easing: 'easeOutQuart' }, // Animação suave
                    scales: {
                        x: { 
                            display: true, 
                            grid: { color: '#333' }, 
                            ticks: { 
                                color: '#888', 
                                maxTicksLimit: 20, // Mostra mais horas
                                autoSkip: true 
                            } 
                        },
                        y: { position: 'right', grid: { color: '#333' }, ticks: { color: '#888' } }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.9)',
                            titleFont: { size: 16 },
                            bodyFont: { size: 14 },
                            callbacks: {
                                label: function(context) {
                                    if (context.dataset.type === 'scatter') {
                                        return context.raw.newsText;
                                    }
                                    return context.formattedValue + ' €';
                                }
                            }
                        }
                    }
                }
            });
        });
    </script>
</body>
</html>
