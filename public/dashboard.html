<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - MoneyFlix</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { 
            background-color: #0a0e17; 
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
            margin: 0;
            padding: 20px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        .header-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; padding-bottom: 15px; height: 12%; }
        .brand-name { font-size: 2.5rem; font-weight: 800; letter-spacing: 2px; color: #888; }
        .big-price-display { font-size: 5rem; font-weight: 700; font-variant-numeric: tabular-nums; color: white; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .price-up { color: #00ff88; } 
        .price-down { color: #ff4444; }

        .chart-wrapper {
            flex-grow: 1; position: relative; width: 100%;
            background: rgba(255,255,255,0.02); border-radius: 8px; padding: 10px;
            box-sizing: border-box; border: 1px solid #222;
            margin-bottom: 15px;
        }

        /* --- BARRA DE FUNDAMENTOS (NOVA) --- */
        .fundamentals-bar {
            display: flex;
            justify-content: space-around;
            background: #111;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
            margin-bottom: 15px;
            height: 12%;
        }
        .fund-item { text-align: center; border-right: 1px solid #333; width: 100%; }
        .fund-item:last-child { border-right: none; }
        .fund-label { font-size: 0.8rem; color: #888; text-transform: uppercase; margin-bottom: 5px; }
        .fund-value { font-size: 1.5rem; font-weight: bold; color: white; }

        .status-badge { font-size: 1.2rem; font-weight: bold; padding: 5px 15px; border-radius: 4px; background: #222; color: #666; margin-top: 5px; display: inline-block; }
        
        .news-footer {
            height: 8%; background: #111; padding: 0 15px;
            border-radius: 5px; display: flex; align-items: center; border-left: 4px solid #444;
        }
    </style>
</head>
<body>

    <div class="header-row">
        <div style="display: flex; flex-direction: column;">
            <div class="brand-name">LUSI <span style="font-size:1rem; color:#444;">(LUSITANA TECH)</span></div>
            <div id="status-display" class="status-badge">AGUARDANDO...</div>
        </div>
        
        <div style="text-align: right; margin-right: 30px;">
            <div style="color: #666; font-size: 0.8rem;">DATA DE MERCADO</div>
            <div id="market-date" style="font-size: 1.5rem; font-weight: bold; color: #00d9ff;">--/--/----</div>
        </div>

        <div id="main-price" class="big-price-display">--- €</div>
    </div>

    <div class="chart-wrapper">
        <canvas id="marketChart"></canvas>
    </div>

    <div class="fundamentals-bar">
        <div class="fund-item">
            <div class="fund-label">Market Cap</div>
            <div class="fund-value" id="dash-mkt-cap">---</div>
        </div>
        <div class="fund-item">
            <div class="fund-label">Ações (Shares)</div>
            <div class="fund-value" id="dash-shares">---</div>
        </div>
        <div class="fund-item">
            <div class="fund-label">P/E Ratio</div>
            <div class="fund-value" id="dash-pe">---</div>
        </div>
        <div class="fund-item">
            <div class="fund-label">EPS (TTM)</div>
            <div class="fund-value" id="dash-eps">---</div>
        </div>
        <div class="fund-item">
            <div class="fund-label">Receita (Q)</div>
            <div class="fund-value" id="dash-rev">---</div>
        </div>
    </div>

    <div class="news-footer">
        <span style="background: #333; color: white; padding: 5px 10px; font-weight: bold; font-size: 0.8rem; margin-right: 15px;">NOTÍCIAS</span>
        <marquee id="news-marquee" style="font-size: 1.8rem; color: #ddd; font-weight: 300;">Bem-vindo ao Mercado.</marquee>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const priceEl = document.getElementById('main-price');
        const statusEl = document.getElementById('status-display');
        const newsEl = document.getElementById('news-marquee');
        const dateEl = document.getElementById('market-date');
        const ctx = document.getElementById('marketChart').getContext('2d');
        
        let marketChart; 

        socket.emit('register-dashboard');

        function initLiveChart() {
            if (marketChart) marketChart.destroy();
            marketChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Preço (€)',
                        data: [],
                        borderColor: '#ffffff',
                        borderWidth: 3,
                        backgroundColor: 'rgba(255, 255, 255, 0.05)',
                        fill: true,
                        pointRadius: 0,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, animation: false,
                    scales: {
                        x: { display: true, grid: { color: '#333' }, ticks: { color: '#666', maxTicksLimit: 10 } },
                        y: { position: 'right', grid: { color: '#333' }, ticks: { color: '#888' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }
        initLiveChart();
        let lastPrice = 0;

        // OUVIR UPDATE COMPLETO
        socket.on('market-update-full', (data) => {
            if (data.mode === 'LIVE') {
                const currentPrice = parseFloat(data.price);
                priceEl.innerText = data.price + "€";
                dateEl.innerText = data.date;
                
                // Atualizar Fundamentos
                document.getElementById('dash-mkt-cap').innerText = data.marketCap;
                document.getElementById('dash-shares').innerText = data.shares;
                document.getElementById('dash-pe').innerText = data.peRatio;
                document.getElementById('dash-eps').innerText = data.eps + "€";
                document.getElementById('dash-rev').innerText = data.revenue;

                // Cor P/E
                const peEl = document.getElementById('dash-pe');
                if (parseFloat(data.peRatio) > 40) peEl.style.color = "#ff4444";
                else if (parseFloat(data.peRatio) < 15) peEl.style.color = "#00ff88";
                else peEl.style.color = "white";

                // Cores Preço
                if (currentPrice > lastPrice) { 
                    priceEl.className = "big-price-display price-up"; 
                    if(marketChart) marketChart.data.datasets[0].borderColor = '#00ff88'; 
                } else if (currentPrice < lastPrice) { 
                    priceEl.className = "big-price-display price-down"; 
                    if(marketChart) marketChart.data.datasets[0].borderColor = '#ff4444'; 
                } else { 
                    priceEl.className = "big-price-display"; 
                }
                lastPrice = currentPrice;

                statusEl.innerText = data.isPaused ? "MERCADO FECHADO" : "● AO VIVO";
                statusEl.style.color = data.isPaused ? "#666" : "#ff4444";
                if (newsEl.innerText !== data.news) newsEl.innerText = data.news;

                if (marketChart) {
                    marketChart.data.labels = data.history.map(h => h.time); // Agora são Datas!
                    marketChart.data.datasets[0].data = data.history.map(h => h.price);
                    marketChart.update();
                }
            }
        });

        // MODO FINAL
        socket.on('market-finish', (data) => {
            statusEl.innerText = "ANÁLISE FINAL";
            statusEl.style.color = "#9d00ff";
            statusEl.style.border = "1px solid #9d00ff";
            newsEl.innerText = "SESSÃO TERMINADA";

            if (marketChart) marketChart.destroy();

            const fullLabels = data.fullHistory.map(h => h.time);
            const eventPoints = data.events.map(evt => ({ x: evt.time, y: evt.price, newsText: evt.text }));
            const pointColors = data.events.map(evt => {
                if (evt.impact > 0) return '#00ff88'; 
                if (evt.impact < 0) return '#ff4444'; 
                return '#ffd700'; 
            });

            marketChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: fullLabels,
                    datasets: [
                        {
                            label: 'Preço (€)',
                            data: data.fullHistory.map(h => h.price),
                            borderColor: '#ffffff', borderWidth: 2, backgroundColor: 'rgba(255, 255, 255, 0.05)',
                            fill: true, pointRadius: 0, tension: 0.3, order: 2
                        },
                        {
                            label: 'Eventos',
                            type: 'scatter',
                            data: eventPoints,
                            pointRadius: 15, pointHoverRadius: 20,
                            backgroundColor: pointColors, borderColor: 'white', borderWidth: 2, order: 1
                        }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { display: true, grid: { color: '#333' }, ticks: { color: '#888', maxTicksLimit: 20, autoSkip: true } },
                        y: { position: 'right', grid: { color: '#333' }, ticks: { color: '#888' } }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.dataset.type === 'scatter') return context.raw.newsText;
                                    return context.formattedValue + ' €';
                                }
                            }
                        }
                    }
                }
            });
        });
    </script>
</body>
</html>
